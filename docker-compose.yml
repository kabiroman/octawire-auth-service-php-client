version: '3.8'

services:
  # PHP клиент с TCP/JSON транспортом, без gRPC extension
  php-dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: octawire-php-client-dev
    working_dir: /app
    volumes:
      - .:/app
      - composer-cache:/tmp/composer-cache
    environment:
      - COMPOSER_CACHE_DIR=/tmp/composer-cache
      - AUTH_TCP_HOST=host.docker.internal
      - AUTH_TCP_PORT=9770
    extra_hosts:
      - "host.docker.internal:172.17.0.1"
    command: tail -f /dev/null
    networks:
      - octawire-dev

  # Redis для тестирования кэширования ключей
  redis:
    image: redis:7-alpine
    container_name: octawire-php-client-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - octawire-dev

  # Auth Service (Go) — источник proto-моделей, TCP/JSON gateway и gRPC API
  auth-service:
    build:
      context: ../..
      dockerfile: Dockerfile.alpine
    container_name: octawire-auth-service-test
    ports:
      - "50051:50051"  # gRPC для Go клиентов
      - "9765:9765"    # HTTP health/metrics
      - "9770:9770"    # JSON/TCP gateway (protojson bridge)
    volumes:
      - ../../config:/etc/auth-service/config:ro
      - /tmp/auth-keys:/tmp/auth-keys:ro
    environment:
      - CONFIG_PATH=/etc/auth-service/config/config.json
    networks:
      - octawire-dev
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9765/health"]
      interval: 10s
      timeout: 3s
      retries: 3
    profiles:
      - with-service

volumes:
  composer-cache:
    driver: local

networks:
  octawire-dev:
    driver: bridge

